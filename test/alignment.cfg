# last update on $Date: 2007/07/12 17:32:40 $ by $Author: flucke $
process Alignment = {
    
    # initialize  MessageLogger
#    include "FWCore/MessageLogger/data/MessageLogger.cfi"
    # This whole mess does not really work - I do not get rid of FwkReport and TrackProducer info...
    service = MessageLogger { 
	untracked vstring destinations = { "alignment" }# {, "cout" }
	untracked vstring statistics = { "alignment" } #{, "cout" }
	untracked vstring categories = { "Alignment", "LogicError", "FwkReport", "TrackProducer"}
	#untracked PSet FwkReport     = { untracked string threshold = "WARNING" }
	#untracked PSet TrackProducer = { untracked string threshold = "WARNING" }
	
	untracked PSet cout    = { 
	    untracked string threshold = "DEBUG" # "ERROR" 
	    untracked PSet FwkReport = {
		untracked string threshold = "ERROR" 
	    }
	    untracked PSet TrackProducer = {
		untracked string threshold = "ERROR" 
	    }
	    #      	untracked bool noLineBreaks = true 
	}
	untracked PSet alignment  = { 
	    untracked string threshold = "DEBUG" 
	    untracked PSet INFO = { untracked int32 limit = 10 }
	    untracked PSet WARNING = { untracked int32 limit = 10 }
	    untracked PSet ERROR = { untracked int32 limit = -1 }
	    untracked PSet DEBUG = { untracked int32 limit = -1 }
	    untracked PSet Alignment = { untracked int32 limit = -1}
	    untracked PSet LogicError = { untracked int32 limit = -1}
	    # untracked bool noLineBreaks = true 
	}
    }
    
    # initialize magnetic field
    include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"
    
    # ideal geometry and interface
    include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
    
    # track selection for alignment
    include "Alignment/CommonAlignmentProducer/data/AlignmentTrackSelector.cfi"
    replace AlignmentTracks.src = ctfWithMaterialTracksBeamHaloMuon #beamTrackproducer #ctfWithMaterialTracks #cosmictrackfinderP5 #AlCaRecoCSA06ZMuMu
    replace AlignmentTracks.ptMin   = 10.
    # replace AlignmentTracks.ptMax   = 999.
    replace AlignmentTracks.etaMin  = -5. # -2.4
    replace AlignmentTracks.etaMax  =  5. # 2.4
    replace AlignmentTracks.nHitMin = 9 # 8
    replace AlignmentTracks.chi2nMax= 999999.
    # replace AlignmentTracks.applyNHighestPt = false
    # replace AlignmentTracks.nHighestPt = 2
    
    # Alignment producer
    include "Alignment/CommonAlignmentProducer/data/AlignmentProducer.cff"
    #replace AlignmentProducer.tjTkAssociationMapTag = cosmictrackfinder # default is TrackRefitter
    # MisalignmentScenarioSettings is a block from Scenario.cff from AlignmentProducer.cff:
    replace MisalignmentScenarioSettings.setError = false # no APE!

    replace AlignmentProducer.ParameterBuilder.Selector = {
	vstring alignParams = {
	    "PixelHalfBarrelLayers,fff00f", # fix pixel
	    "BarrelRodsLayers12,111001", # 4 params for double sided barrel
	    "BarrelRodsLayers35,101001", # 3 params for single sided barrel
	    "TOBRodsLayers66,c0c00c"# ,  (except of fixed last layer, taken out of hierarchy)
#	    "TOBRodsLayers66,C0C00C", # (except of fixed last layer, taken out of hierarchy)
#	    "TIBHalfBarrels,111000",
#	    "TOBHalfBarrels,111000"

# CSA06
#            "TOBDSRods,111111","TOBSSRodsLayers15,1ff111",
#            "TIBDSDets,111111","TIBSSDets,1ff111",
#	    "TOBSSRodsLayers66,ffffff",
#	    "PixelHalfBarrelLayers,ffffff"
# NOTE 2006/11 A
#	    "PixelHalfBarrelLayers,fff00f", # fix pixel
#	    "BarrelRodsDS,111001,centralEta",      # 4 params for double sided barrel
#	    "TIBRodsSS,1f1001,centralEta",         # fix global z/local y for single sided TIB...
#	    "TOBRodsSSLayers15,1f1001,centralEta", # ...and TOB
#	    "TOBRodsSSLayers66,cfc00c,centralEta"  # except of fixed last layer
# Layer level
#	    "BarrelLayersDS,111001,centralEta",      # 4 params for double sided barrel
#	    "TIBLayersSS,1f1001,centralEta",         # fix global z/local y for single sided TIB...
#	    "TOBLayersSSLayers15,1f1001,centralEta", # ...and TOB
#	    "TOBLayersSSLayers66,cfc00c,centralEta"  # except of fixed last layer

# NOTE 2006/11 B (?)
#	    "PixelHalfBarrelDets,ccc00c", # fix pixel
#	    "BarrelDetsDS,111001,centralEta",      # 4 params for double sided barrel
#	    "TIBDetsSS,1f1001,centralEta",         # fix global z/local y for single sided TIB...
#	    "TOBDetsSSLayers15,1f1001,centralEta", # ...and TOB
#	    "TOBDetsSSLayers66,cfc00c,centralEta"  # except of fixed last layer
	}
	PSet centralEta = {
	    vdouble etaRanges =  {-0.9, 0.9}
	    # empty array means no restriction:
	    vdouble xRanges = {}  vdouble yRanges = {}  vdouble zRanges = {}  
	    vdouble rRanges = {}  vdouble phiRanges = {}
	}
    }

    replace AlignmentProducer.doMisalignmentScenario = false #true
    # replace AlignmentProducer.MisalignmentScenario.seed = 6543217
    replace AlignmentProducer.MisalignmentScenario.TPBs.scale = 0.
#    replace AlignmentProducer.MisalignmentScenario.TPBs = {
#	string distribution = "fixed"
#	PSet PixelHalfBarrelLayers = {
#	    double dXlocal = 0.1 double dYlocal = -0.05 double dZlocal = 0.1 
#	    double phiXlocal = 0.0001 double phiYlocal = 0.0004 double phiZlocal = 0.00004
#	}
##	PSet PixelHalfBarrelLayer2 = {
##	    double dXlocal = 0.15 double dYlocal = 0.05 double dZlocal = 0.1 
##	}
##	PSet PixelHalfBarrelLayer3 = {
##	    double dXlocal = 0.2 double dYlocal = 0.05 double dZlocal = 0.3 
##	}
#    }
    replace AlignmentProducer.MisalignmentScenario.TPEs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TECs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TIDs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TIBs.Dets = { double scale = 0.}
    replace AlignmentProducer.MisalignmentScenario.TOBs.Dets = { double scale = 0.}
#    include "Alignment/MillePedeAlignmentAlgorithm/test/myMisalignmentScenario.cff"

    replace AlignmentProducer.algoConfig = {
	using MillePedeAlignmentAlgorithm
    }
    replace MillePedeAlignmentAlgorithm.mode = "mille" # "full" #"pede" #"mille"
#    replace MillePedeAlignmentAlgorithm.fileDir = "/scratch/flucke/lxbatch/milleCosmics"
#    replace MillePedeAlignmentAlgorithm.binaryFile = "milleBinary_hiera131d.dat"
#    replace MillePedeAlignmentAlgorithm.treeFile = "treeFile_hiera131d.root"
#    replace MillePedeAlignmentAlgorithm.monitorFile = "millePedeMonitor_hiera131d.root"
    replace MillePedeAlignmentAlgorithm.pedeSteerer.method = "inversion  9  0.8"
    #                                                                    <method>  n(iter)  Delta(F)
    replace MillePedeAlignmentAlgorithm.pedeSteerer.options = {
	"chisqcut  20.0  4.5"} #{,  "outlierdownweighting 3",   "dwfractioncut 0.1"}
    # replace MillePedeAlignmentAlgorithm.useTrackTsos = false
    replace MillePedeAlignmentAlgorithm.TrajectoryFactory = {
#	using BzeroReferenceTrajectoryFactory
#	using TwoBodyDecayTrajectoryFactory
	string TrajectoryFactoryName = "thisisnotname"

    }

# refitting for normal tracks...
    include "RecoTracker/TrackProducer/data/RefitterWithMaterial.cff"
    include "RecoTracker/TransientTrackingRecHit/data/TransientTrackingRecHitBuilderWithoutRefit.cfi"
    replace TrackRefitter.src = "AlignmentTracks" //"beamTrackproducer"
    replace TrackRefitter.TrajectoryInEvent = true
    replace TrackRefitter.TTRHBuilder = "WithoutRefit"# TransientTrackingRecHitBuilder: no refit of hits...
    replace ttrhbwor.Matcher = "StandardMatcher" # ... but with matching for strip stereo!
    replace MaterialPropagator.MaxDPhi = 1000. # PropagatorWithMaterial 
# ...or new cosmic track reco for cosmics:
##    include "Alignment/MillePedeAlignmentAlgorithm/test/AlignmentProducerFittingCosmics.cff"
##    replace cosmictrackfinder.TrajInEvents=true # is already default?
#    include "RecoLocalTracker/Configuration/data/RecoLocalTracker.cff"
#    include "RecoTracker/Configuration/data/RecoTracker.cff"
#    include "RecoTracker/SingleTrackPattern/data/CosmicTrackFinderP5.cff"

    # input file
#    source = EmptySource {untracked int32 maxEvents = 0}
    source = PoolSource { 
#	include "Alignment/MillePedeAlignmentAlgorithm/test/files_AlCaReco_ZToMuMu-LowLumiPU.cff"
	untracked vstring fileNames = { 
	    #"aFile.root"
	    "rfio:/castor/cern.ch/user/v/vlimant/beamHaloProduction/150/BH_trackReco_comb_2_9/beamHaloMuon_150_trackReco_comb_2_9.root"
	}
	untracked uint32 skipEvents = 0
    }
    # untracked PSet maxEvents = {untracked int32 input = 100}
    path p = { AlignmentTracks, TrackRefitter }
#cosmics:
#    path p = { mycosmics }
}
