# last update on $Date: 2008/05/21 12:28:20 $ by $Author: flucke $
process Alignment = {
    
    # initialize  MessageLogger
#    include "FWCore/MessageLogger/data/MessageLogger.cfi"
    # This whole mess does not really work - I do not get rid of FwkReport and TrackProducer info...
    service = MessageLogger { 
	untracked vstring destinations = { "alignment" }# {, "cout" }
	untracked vstring statistics = { "alignment" } #{, "cout" }
	untracked vstring categories = { "Alignment", "LogicError", "FwkReport", "TrackProducer"}
	#untracked PSet FwkReport     = { untracked string threshold = "WARNING" }
	#untracked PSet TrackProducer = { untracked string threshold = "WARNING" }
	
	untracked PSet cout    = { 
	    untracked string threshold = "DEBUG" # "ERROR" 
	    untracked PSet FwkReport = {
		untracked string threshold = "ERROR" 
	    }
	    untracked PSet TrackProducer = {
		untracked string threshold = "ERROR" 
	    }
	    #      	untracked bool noLineBreaks = true 
	}
	untracked PSet alignment  = { 
	    untracked string threshold = "DEBUG" 
	    untracked PSet INFO = { untracked int32 limit = 10 }
	    untracked PSet WARNING = { untracked int32 limit = 10 }
	    untracked PSet ERROR = { untracked int32 limit = -1 }
	    untracked PSet DEBUG = { untracked int32 limit = -1 }
	    untracked PSet Alignment = { untracked int32 limit = -1}
	    untracked PSet LogicError = { untracked int32 limit = -1}
	    # untracked bool noLineBreaks = true 
	}
    }
    
    # initialize magnetic field
    include "Configuration/StandardSequences/data/MagneticField.cff"    
    # ideal geometry and interface
    include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
    # for Muon: include "Geometry/MuonNumbering/data/muonNumberingInitialization.cfi"

    include "Configuration/StandardSequences/data/FrontierConditions_GlobalTag.cff"    
    replace GlobalTag.globaltag = "IDEAL::All"

    include "RecoVertex/BeamSpotProducer/data/BeamSpot.cfi"
    # track selection for alignment
    include "Alignment/CommonAlignmentProducer/data/AlignmentTrackSelector.cfi"
    replace AlignmentTrackSelector.src = generalTracks # ALCARECOTkAlMinBias # ctfWithMaterialTracksBeamHaloMuon #beamTrackproducer #ctfWithMaterialTracks #cosmictrackfinderP5 #AlCaRecoCSA06ZMuMu
    replace AlignmentTrackSelector.ptMin   = 2. # 10.
    # replace AlignmentTrackSelector.ptMax   = 999.
    replace AlignmentTrackSelector.etaMin  = -5. # -2.4
    replace AlignmentTrackSelector.etaMax  =  5. # 2.4
    replace AlignmentTrackSelector.nHitMin = 9 # 8
    replace AlignmentTrackSelector.chi2nMax= 100. # 999999.
    replace AlignmentTrackSelector.applyNHighestPt = true #false
    replace AlignmentTrackSelector.nHighestPt = 2
    
    # Alignment producer
    include "Alignment/CommonAlignmentProducer/data/AlignmentProducer.cff"
    #replace AlignmentProducer.tjTkAssociationMapTag = cosmictrackfinder # default is TrackRefitter
    # MisalignmentScenarioSettings is a block from Scenario.cff from AlignmentProducer.cff:
    # replace MisalignmentScenarioSettings.setError = false # no APE for refitter (not recomended)

    replace AlignmentProducer.ParameterBuilder.Selector = {
	vstring alignParams = {
	    # 6 parameters for larger structures, pixel as reference
	    "PixelHalfBarrels,rrrrrr",
	    "TrackerTOBHalfBarrel,111111",
	    "TrackerTIBHalfBarrel,111111",
	    "TrackerTECEndcap,111111",
	    "TrackerTIDEndcap,111111",
	    # 4 params for double sided strip barrel and pixel
	    "PixelDets,111001",
	    "BarrelDetsDS,111001",
	    "TECDets,111001,endCapDS",
	    "TIDDets,111001,endCapDS",
	    # 3 params for single sided barrel
	    "BarrelDetsSS,101001",
	    "TECDets,101001,endCapSS",
	    "TIDDets,101001,endCapSS"

# very simple scenario for testing
#	    # 6 parameters for larger structures, pixel as reference
#	    "PixelHalfBarrels,ffffff",
#	    "TrackerTOBHalfBarrel,111111",
#	    "TrackerTIBHalfBarrel,111111",
#	    "TrackerTECEndcap,ffffff",
#	    "TrackerTIDEndcap,ffffff" 
	}
        PSet endCapSS = {
            vdouble etaRanges = {}  vdouble phiRanges = {} vdouble zRanges = {}
	    vdouble rRanges   = {40., 60., 75., 999.}
	    vdouble xRanges = {}  vdouble yRanges = {}
        }
        PSet endCapDS = {
            vdouble etaRanges = {}  vdouble phiRanges = {} vdouble zRanges = {}
	    vdouble rRanges   = {0., 40., 60., 75.}
	    vdouble xRanges = {}  vdouble yRanges = {}
        }
    }
    # replace AlignmentProducer.doMuon = true
    replace AlignmentProducer.doMisalignmentScenario = false #true
    #    replace AlignmentProducer.MisalignmentScenario = {
    #	using MisalignmentScenarioSettings
    #	PSet TOBs = {
    #	    double dXlocal = 0.0600 double dYlocal = 0.0600 double dZlocal = 0.0600 
    #	    double phiXlocal = 0.000270 double phiYlocal = 0.000270 double phiZlocal = 0.000270 }
    #	PSet TIBs = {
    #	    double dXlocal = 0.0600 double dYlocal = 0.0600 double dZlocal = 0.0600 
    #	    double phiXlocal = 0.002070 double phiYlocal = 0.002070 double phiZlocal = 0.002070 }
    #    }
    #    replace AlignmentProducer.MisalignmentScenario.seed = 6543217
    #    replace AlignmentProducer.MisalignmentScenario.TPBs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TPEs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TECs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TIDs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TIBs.Dets = { double scale = 0.}
    #    replace AlignmentProducer.MisalignmentScenario.TOBs.Dets = { double scale = 0.}

    replace AlignmentProducer.algoConfig = {
	using MillePedeAlignmentAlgorithm
    }
    #    replace MillePedeAlignmentAlgorithm.mode = "mille" #"full" # "pedeSteer" #"pede"
    #    replace MillePedeAlignmentAlgorithm.fileDir = "/scratch/flucke/lxbatch/milleCosmics"
    #    replace MillePedeAlignmentAlgorithm.binaryFile = "/tmp/flucke/milleBinary.dat" 
    #    replace MillePedeAlignmentAlgorithm.treeFile = "treeFile_hiera131d.root"
    #    replace MillePedeAlignmentAlgorithm.monitorFile = "millePedeMonitor_hiera131d.root"
    #    default is sparsGMRES                                    <method>  n(iter)  Delta(F)
    #    replace MillePedeAlignmentAlgorithm.pedeSteerer.method = "inversion  9  0.8"
    #    replace MillePedeAlignmentAlgorithm.pedeSteerer.options = {
    #	"entries 100",
    #	"chisqcut  20.0  4.5" # "outlierdownweighting 3", "dwfractioncut 0.1" 
    #    }
    #    replace MillePedeAlignmentAlgorithm.TrajectoryFactory = {
    #      using BzeroReferenceTrajectoryFactory # OR using TwoBodyDecayTrajectoryFactory OR using...
    #    }
    # replace MillePedeAlignmentAlgorithm.max2Dcorrelation = 2. # to switch off
    # FIXME: Need updated presigma scenarios (or implement use of survey object?)
    include "Alignment/MillePedeAlignmentAlgorithm/data/PresigmaScenarios.cff"
    replace MillePedeAlignmentAlgorithm.pedeSteerer.Presigmas += TrackerShortTermPresigmas.Presigmas
    
# refitting
    include "RecoTracker/TrackProducer/data/RefitterWithMaterial.cff"
    replace TrackRefitter.src = "AlignmentTrackSelector"
    replace TrackRefitter.TrajectoryInEvent = true
    # beam halo propagation needs larger phi changes going from one TEC to another
    # replace MaterialPropagator.MaxDPhi = 1000.

    # input file
#    source = EmptySource {} # for pede only mode
    source = PoolSource {
	untracked vstring fileNames = { 
	    #"file:aFile.root" #"rfio:/castor/cern.ch/cms/store/..."
            # relval file from CMSSW_2_1_0_pre5:
	    "/store/relval/2008/6/4/RelVal-RelValZMM-1212543891-STARTUP-2nd/0000/0A9973E2-9A32-DD11-BE04-001617E30F50.root"
	}
	untracked uint32 skipEvents = 0
    }
#    untracked PSet maxEvents = {untracked int32 input = 100}

    path p = { offlineBeamSpot, AlignmentTrackSelector, TrackRefitter }
}
