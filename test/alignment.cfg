# last update on $Date: 2007/02/13 12:03:11 $ by $Author: flucke $
process Alignment = {
    
    # initialize  MessageLogger
    # include "FWCore/MessageLogger/data/MessageLogger.cfi"
    # This whole mess does not really work - I do not get rid of FwkReport and TrackProducer info...
    service = MessageLogger { 
	untracked vstring destinations = { "alignment" }# , "cout" }
	untracked vstring statistics = { "alignment"}# , "cout" }
	untracked vstring categories = { "Alignment", "LogicError", "FwkReport", "TrackProducer"}
	#untracked PSet FwkReport     = { untracked string threshold = "WARNING" }
	#untracked PSet TrackProducer = { untracked string threshold = "WARNING" }

	untracked PSet cout    = { 
	    untracked string threshold = "DEBUG" # "ERROR" 
	    untracked PSet FwkReport = {
		untracked string threshold = "ERROR" 
	    }
	    untracked PSet TrackProducer = {
		untracked string threshold = "ERROR" 
	    }
	    #      	untracked bool noLineBreaks = true 
	}
	untracked PSet alignment  = { 
	    untracked string threshold = "DEBUG" 
	    untracked PSet INFO = { untracked int32 limit = 10 }
	    untracked PSet WARNING = { untracked int32 limit = 10 }
	    untracked PSet ERROR = { untracked int32 limit = -1 }
	    untracked PSet DEBUG = { untracked int32 limit = -1 }
	    untracked PSet Alignment = { untracked int32 limit = -1}
	    untracked PSet LogicError = { untracked int32 limit = -1}
	    # untracked bool noLineBreaks = true 
	}
    }
    
    # initialize magnetic field
    include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"
    
    # ideal geometry and interface
    include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
    
    # track selection for alignment
    module AlignmentTracks = AlignmentTrackSelectorModule {
	InputTag src = AlCaRecoCSA06ZMuMu #cosmictrackfinder # ctfWithMaterialTracks  # AlCaReco
	bool filter = false
	
	bool applyBasicCuts = false #true
	double ptMin   = 15. #10. #5. 
	double ptMax   = 9999.
	double etaMin  = -99. #-2.4.
	double etaMax  =  99. #2.4.
	double phiMin  = -3.1416
	double phiMax  =  3.1416
	double nHitMin = 5 #10
	double nHitMax = 99
	double chi2nMax= 999. #999999.

	bool applyNHighestPt = false
	int32 nHighestPt = 2
	
	bool applyMultiplicityFilter = true
	int32 minMultiplicity = 1
    }
    
    # Alignment producer
    include "Alignment/CommonAlignmentProducer/data/AlignmentProducer.cff"
#    replace AlignmentProducer.tkTag = "cosmictrackfinder" # default is 'AlignmentTracks'
#    replace AlignmentProducer.tjTag = "cosmictrackfinder"

    replace AlignmentProducer.ParameterBuilder.Selector = {
	vstring alignParams = {
# CSA06
#            "TOBDSRods,111111","TOBSSRodsLayers15,1ff111",
#            "TIBDSDets,111111","TIBSSDets,1ff111",
#	    "TOBSSRodsLayers66,ffffff",
#	    "PixelHalfBarrelLayers,ffffff"
## NOTE 2006/11 A with hierarchy, no eta cut
#	    "PixelHalfBarrelLayers,fff00f", # fix pixel
#	    "BarrelRodsLayers12,111001,centralEta",      # 4 params for double sided barrel
#	    "BarrelRodsLayers35,1f1001,centralEta",
#	    "TOBRodsLayers66,cfc00c,centralEta",  # fixed last layer
#	    "BarrelLayersLayers12,111001",      # no eta cut: x=y=0
#	    "BarrelLayersLayers35,1f1001"       # 
# NOTE 2006/11 A with hierarchy, no eta cut
#	    "PixelHalfBarrelLayers,fff00f", # fix pixel
#	    "BarrelRodsLayers12,111001,centralEta",      # 4 params for double sided barrel
#	    "BarrelRodsLayers35,1f1001,centralEta",
#	    "TOBRodsLayers66,cfc00c,centralEta",  # fixed last layer
#	    "BarrelLayersLayers12,111001",      # no eta cut: x=y=0
#	    "BarrelLayersLayers35,1f1001"       # 
# NOTE 2006/11 A
	    "PixelHalfBarrelLayers,fff00f", # fix pixel
	    "BarrelRodsDS,111001,centralEta",      # 4 params for double sided barrel
	    "TIBRodsSS,1f1001,centralEta",         # fix global z/local y for single sided TIB...
	    "TOBRodsSSLayers15,1f1001,centralEta", # ...and TOB
	    "TOBRodsSSLayers66,cfc00c,centralEta"  # except of fixed last layer
# Layer level
#	    "BarrelLayersDS,111001,centralEta",      # 4 params for double sided barrel
#	    "TIBLayersSS,1f1001,centralEta",         # fix global z/local y for single sided TIB...
#	    "TOBLayersSSLayers15,1f1001,centralEta", # ...and TOB
#	    "TOBLayersSSLayers66,cfc00c,centralEta"  # except of fixed last layer

# NOTE 2006/11 B (?)
#	    "PixelHalfBarrelDets,ccc00c", # fix pixel
#	    "BarrelDetsDS,111001,centralEta",      # 4 params for double sided barrel
#	    "TIBDetsSS,1f1001,centralEta",         # fix global z/local y for single sided TIB...
#	    "TOBDetsSSLayers15,1f1001,centralEta", # ...and TOB
#	    "TOBDetsSSLayers66,cfc00c,centralEta"  # except of fixed last layer
	}
	PSet centralEta = {
	    vdouble etaRanges =  {-0.9, 0.9}
	    # empty array means no restriction:
	    vdouble zRanges = {}  vdouble rRanges = {}  vdouble phiRanges = {}
	}
    }

    replace AlignmentProducer.doMisalignmentScenario = true
    # replace AlignmentProducer.MisalignmentScenario.seed = 6543217
##    MisalignmentScenarioSettings is a block from Scenario.cff from AlignmentProducer.cff:
    replace MisalignmentScenarioSettings.setError = false 
    replace AlignmentProducer.MisalignmentScenario.TPBs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TPEs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TECs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TIDs.scale = 0.
    replace AlignmentProducer.MisalignmentScenario.TIBs.Dets = { double scale = 0.}
#    replace AlignmentProducer.MisalignmentScenario.TOBs.Dets = { double scale = 0.}
    replace AlignmentProducer.MisalignmentScenario.TOBs.scale = 0.
#    include "Alignment/MillePedeAlignmentAlgorithm/test/myMisalignmentScenario.cff"
#    replace AlignmentProducer.MisalignmentScenario = {
##	using TrackerCSA06Scenario
#	using BarrelRodsSensitiveParFixedTOBLayer6Scenario
#    }


    replace AlignmentProducer.algoConfig = {
	# using MillePedeAlignmentAlgorithm
	string algoName = "MillePedeAlignmentAlgorithm"
	# possible modes: full, mille, pede, pedeSteer, pedeRun, pedeRead
	untracked string mode = "mille" #"full" #"mille"

	untracked string fileDir = ""

 	string binaryFile = "milleBinary.dat"
        vstring mergeBinaryFiles = {}
	string treeFile   = "treeFile.root"
        vstring mergeTreeFiles = {} 
	untracked string monitorFile = "millePedeMonitor.root" # if empty: no monitoring...

	PSet pedeSteerer = {
	    string steerFile = "pedeSteer" # beginning of steering file names
	    untracked string pedeCommand = "/afs/cern.ch/user/f/flucke/cms/pede/vers20070124/pede"
	    untracked string pedeDump = "pede.dump"
	    string method = "inversion  6  1." # <method>  n(iter)  Delta(F)
#	    string method = "fullGMRES 6  0.1" # <method>  n(iter)  Delta(F)
	    vstring outlier = {"chisqcut  9.0  5.0"}#, 
		             #  "outlierdownweighting 3",
		             #  "dwfractioncut 0.1"}
	    vstring options = {} #"bandwidth 6"}
	}
        PSet pedeReader = {
	    string readFile = "millepede.res"
            untracked string fileDir = "" # directory of 'readFile', if empty: take from pedeSteerer
        }
	int32 minNumHits = 5 # minimum number of hits (with alignable parameters)
	bool  useTrackTsos = true # Tsos from track or from reference trajectory for global derivs
    }

    include "Alignment/CommonAlignmentProducer/data/AlignmentProducerRefitting.cff"
    replace TrackRefitter.src = "AlignmentTracks"
    replace TrackRefitter.TTRHBuilder = "WithoutRefit"
    replace TrackRefitter.TrajectoryInEvent = true

#    include "Alignment/MillePedeAlignmentAlgorithm/test/AlignmentProducerFittingCosmics.cfi"

    # input file
#    source = EmptySource {untracked int32 maxEvents = 0}
    source = PoolSource { 
#	include "Alignment/MillePedeAlignmentAlgorithm/test/files_AlCaReco_ZToMuMu-LowLumiPU.cff"
	untracked vstring fileNames = { 
	    'rfio:/castor/cern.ch/user/f/flucke/alignment/AlCaReco/CMSSW_1_2_0/ZToMuMu-LowLumiPU/AlCaRecoZMuMu_1651_1800.root'
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin10_thMax65_seed70546219.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin10_thMax75_seed1234567.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin10_thMax75_seed7758621.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin10_thMax88_seed7054621.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin2_thMax65_seed987654.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin2_thMax75_seed7076543.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin2_thMax75_seed7876543.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin2_thMax75_seed9876543.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin2_thMax88_seed19876543.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin5_thMax65_seed9854321.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin5_thMax75_seed83254761.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin5_thMax75_seed9054321.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin5_thMax75_seed9954321.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin5_thMax75_seed9959321.root",
#	    "file:/scratch/flucke/lxbatch/cosmics2/cosmics_Emin5_thMax88_seed3054321.root"
	}
 	untracked int32 maxEvents   = 1000 #2000 #200
	untracked uint32 skipEvents = 0
    }
    
# normal 
    path p = { AlignmentTracks, TrackRefitter }
#cosmics
#    path p = { mycosmics }
	
    # REPLACEME (needed for inserting replace statements by perl script!)

}
