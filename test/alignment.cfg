# last update on $Date: 2007/07/19 12:20:58 $ by $Author: flucke $
process Alignment = {
    
    # initialize  MessageLogger
#    include "FWCore/MessageLogger/data/MessageLogger.cfi"
    # This whole mess does not really work - I do not get rid of FwkReport and TrackProducer info...
    service = MessageLogger { 
	untracked vstring destinations = { "alignment" }# {, "cout" }
	untracked vstring statistics = { "alignment" } #{, "cout" }
	untracked vstring categories = { "Alignment", "LogicError", "FwkReport", "TrackProducer"}
	#untracked PSet FwkReport     = { untracked string threshold = "WARNING" }
	#untracked PSet TrackProducer = { untracked string threshold = "WARNING" }
	
	untracked PSet cout    = { 
	    untracked string threshold = "DEBUG" # "ERROR" 
	    untracked PSet FwkReport = {
		untracked string threshold = "ERROR" 
	    }
	    untracked PSet TrackProducer = {
		untracked string threshold = "ERROR" 
	    }
	    #      	untracked bool noLineBreaks = true 
	}
	untracked PSet alignment  = { 
	    untracked string threshold = "DEBUG" 
	    untracked PSet INFO = { untracked int32 limit = 10 }
	    untracked PSet WARNING = { untracked int32 limit = 10 }
	    untracked PSet ERROR = { untracked int32 limit = -1 }
	    untracked PSet DEBUG = { untracked int32 limit = -1 }
	    untracked PSet Alignment = { untracked int32 limit = -1}
	    untracked PSet LogicError = { untracked int32 limit = -1}
	    # untracked bool noLineBreaks = true 
	}
    }
    
    # initialize magnetic field
    include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"
    
    # ideal geometry and interface
    include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
    
    # track selection for alignment
    include "Alignment/CommonAlignmentProducer/data/AlignmentTrackSelector.cfi"
    replace AlignmentTracks.src = ctfWithMaterialTracksBeamHaloMuon #beamTrackproducer #ctfWithMaterialTracks #cosmictrackfinderP5 #AlCaRecoCSA06ZMuMu
    replace AlignmentTracks.ptMin   = 10.
    # replace AlignmentTracks.ptMax   = 999.
    replace AlignmentTracks.etaMin  = -5. # -2.4
    replace AlignmentTracks.etaMax  =  5. # 2.4
    replace AlignmentTracks.nHitMin = 9 # 8
    replace AlignmentTracks.chi2nMax= 999999.
    # replace AlignmentTracks.applyNHighestPt = false
    # replace AlignmentTracks.nHighestPt = 2
    
    # Alignment producer
    include "Alignment/CommonAlignmentProducer/data/AlignmentProducer.cff"
    #replace AlignmentProducer.tjTkAssociationMapTag = cosmictrackfinder # default is TrackRefitter
    # MisalignmentScenarioSettings is a block from Scenario.cff from AlignmentProducer.cff:
    # replace MisalignmentScenarioSettings.setError = false # no APE for refitter (not recomended)

    replace AlignmentProducer.ParameterBuilder.Selector = {
	vstring alignParams = {
	    # 6 parameters for larger structures, pixel as reference
	    "PixelHalfBarrels,rrrrrr",
	    "TrackerTOBHalfBarrel,111111",
	    "TrackerTIBHalfBarrel,111111",
	    "TrackerTECEndcap,111111",
	    "TrackerTIDEndcap,111111",
	    # 4 params for double sided strip barrel and pixel
	    "PixelDets,111001",
	    "BarrelDetsDS,111001",
	    "TECDets,111001,endCapDS",
	    "TIDDets,111001,endCapDS",
	    # 3 params for single sided barrel
	    "BarrelDetsSS,101001",
	    "TECDets,101001,endCapSS",
	    "TIDDets,101001,endCapSS"
	}
        PSet endCapSS = {
            vdouble etaRanges = {}  vdouble phiRanges = {} vdouble zRanges = {}
	    vdouble rRanges   = {40., 60., 75., 999.}
	    vdouble xRanges = {}  vdouble yRanges = {}
        }
        PSet endCapDS = {
            vdouble etaRanges = {}  vdouble phiRanges = {} vdouble zRanges = {}
	    vdouble rRanges   = {0., 40., 60., 75.}
	    vdouble xRanges = {}  vdouble yRanges = {}
        }
    }

    replace AlignmentProducer.doMisalignmentScenario = false #true
    #    replace AlignmentProducer.MisalignmentScenario.seed = 6543217
    #    replace AlignmentProducer.MisalignmentScenario.TPBs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TPEs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TECs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TIDs.scale = 0.
    #    replace AlignmentProducer.MisalignmentScenario.TIBs.Dets = { double scale = 0.}
    #    replace AlignmentProducer.MisalignmentScenario.TOBs.Dets = { double scale = 0.}

    replace AlignmentProducer.algoConfig = {
	using MillePedeAlignmentAlgorithm
    }
    #    replace MillePedeAlignmentAlgorithm.mode = "full" # "mille" # "pedeSteer" #"pede" #"mille"
    #    replace MillePedeAlignmentAlgorithm.fileDir = "/scratch/flucke/lxbatch/milleCosmics"
    #    replace MillePedeAlignmentAlgorithm.binaryFile = "milleBinary_hiera131d.dat"
    #    replace MillePedeAlignmentAlgorithm.treeFile = "treeFile_hiera131d.root"
    #    replace MillePedeAlignmentAlgorithm.monitorFile = "millePedeMonitor_hiera131d.root"
    #    default is sparsGMRES                                    <method>  n(iter)  Delta(F)
    #    replace MillePedeAlignmentAlgorithm.pedeSteerer.method = "inversion  9  0.8"
    #    replace MillePedeAlignmentAlgorithm.pedeSteerer.options = {
    #	"entries 100",
    #	"chisqcut  20.0  4.5" # "outlierdownweighting 3", "dwfractioncut 0.1" 
    #    }
    #    replace MillePedeAlignmentAlgorithm.TrajectoryFactory = {
    #      using BzeroReferenceTrajectoryFactory # OR using TwoBodyDecayTrajectoryFactory OR using...
    #    }
    # FIXME: Need updated presigma scenarios (or implement use of survey object?)
    include "Alignment/MillePedeAlignmentAlgorithm/data/PresigmaScenarios.cff"
    replace MillePedeAlignmentAlgorithm.pedeSteerer.Presigmas += TrackerShortTermPresigmas.Presigmas
    
# refitting
    include "RecoTracker/TrackProducer/data/RefitterWithMaterial.cff"
    replace TrackRefitter.src = "AlignmentTracks"
    replace TrackRefitter.TrajectoryInEvent = true
    # needed for refit of hits:
    # include "CalibTracker/Configuration/data/SiStrip_FakeLorentzAngle.cff" # or Frontier or...
    # usually without refit: 
    replace TrackRefitter.TTRHBuilder = "WithoutRefit"# TransientTrackingRecHitBuilder: no refit of hits...
    include "RecoTracker/TransientTrackingRecHit/data/TransientTrackingRecHitBuilderWithoutRefit.cfi"
    # ... but matching for strip stereo should be redone: 
    replace ttrhbwor.Matcher = "StandardMatcher"
    # beam halo propagation needs larger phi changes going from one TEC to another
    # replace MaterialPropagator.MaxDPhi = 1000.

    # input file
#    source = EmptySource {} # for pede only mode
    source = PoolSource {
	untracked vstring fileNames = { 
	    #"file:aFile.root" #"rfio:/castor/cern.ch/cms/store/..."
	    "file:/afs/cern.ch/user/f/flucke/scratch0/CMSSW_1_2_6/cosmics_sim.root"
	}
	untracked uint32 skipEvents = 0
    }
    untracked PSet maxEvents = {untracked int32 input = 0}

    path p = { AlignmentTracks, TrackRefitter }
}
